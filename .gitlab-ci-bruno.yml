# GitLab CI Configuration for Bruno API Integration Tests
# Add this to your main .gitlab-ci.yml or include it as a separate file

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

stages:
  - build
  - test
  - api-integration-tests

cache:
  paths:
    - .m2/repository/
    - node_modules/

# Build and unit tests (existing)
maven-test:
  stage: test
  image: openjdk:21-jdk
  script:
    - ./mvnw $MAVEN_CLI_OPTS clean compile test
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/
  coverage: '/Total.*?([0-9]{1,3})%/'

# Build application for API tests
build-app:
  stage: build
  image: openjdk:21-jdk
  script:
    - ./mvnw $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 hour

# Bruno API Integration Tests
api-integration-tests:
  stage: api-integration-tests
  image: node:18-alpine
  services:
    - postgres:13-alpine
  variables:
    POSTGRES_DB: buckpal_test
    POSTGRES_USER: buckpal
    POSTGRES_PASSWORD: buckpal
    SPRING_PROFILES_ACTIVE: ci
    DATABASE_URL: jdbc:postgresql://postgres:5432/buckpal_test
    DATABASE_USERNAME: buckpal
    DATABASE_PASSWORD: buckpal
  before_script:
    # Install Java to run Spring Boot app
    - apk add --no-cache openjdk21-jre
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
    - export PATH=$JAVA_HOME/bin:$PATH
    
    # Install Bruno CLI
    - npm install -g @usebruno/cli
    
    # Wait for database
    - apk add --no-cache postgresql-client
    - until pg_isready -h postgres -p 5432; do sleep 1; done
    
    # Start Spring Boot application in background
    - java -jar target/*.jar --spring.profiles.active=ci &
    - APP_PID=$!
    
    # Wait for application to be ready
    - |
      echo "Waiting for Spring Boot application to start..."
      for i in {1..60}; do
        if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
          echo "Application is ready!"
          break
        fi
        if [ $i -eq 60 ]; then
          echo "Application failed to start within 60 seconds"
          exit 1
        fi
        sleep 2
      done
  script:
    # Run Bruno tests
    - cd bruno-tests/BuckPal-API
    - bru run --env CI --output junit.xml --format junit
  after_script:
    # Stop Spring Boot application
    - kill $APP_PID || true
  artifacts:
    reports:
      junit:
        - bruno-tests/BuckPal-API/junit.xml
    paths:
      - bruno-tests/BuckPal-API/junit.xml
    when: always
  only:
    - merge_requests
    - main
    - develop